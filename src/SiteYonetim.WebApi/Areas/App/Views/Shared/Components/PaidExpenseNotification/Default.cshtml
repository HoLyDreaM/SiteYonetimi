@model SiteYonetim.WebApi.Areas.App.ViewComponents.NotificationViewModel
@{
    var siteId = ViewData["SiteId"]?.ToString() ?? ViewContext.HttpContext.Request.Query["siteId"].FirstOrDefault() ?? "";
    var overdueExpenses = Model?.OverdueExpenses ?? Array.Empty<SiteYonetim.Domain.Interfaces.OverdueExpenseNotificationDto>();
    var debtors = Model?.Debtors ?? Array.Empty<SiteYonetim.Domain.Interfaces.DebtorDto>();
    var hasNotifications = overdueExpenses.Count > 0 || debtors.Count > 0;
    var totalCount = overdueExpenses.Count + debtors.Count;
}
<div class="dropdown">
    <button class="btn btn-link text-dark text-decoration-none p-2 position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Bildirimler">
        <i class="bi bi-bell-fill fs-5"></i>
        @if (hasNotifications)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">@totalCount</span>
        }
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 320px; max-width: 400px;">
        @if (string.IsNullOrEmpty(siteId))
        {
            <li><span class="dropdown-item text-muted">Bildirimler için bir site seçin.</span></li>
        }
        else
        {
        <li><h6 class="dropdown-header">Süresi Geçen Giderler</h6></li>
        @if (overdueExpenses.Count > 0)
        {
            @foreach (var item in overdueExpenses.Take(5))
            {
                <li>
                    <a class="dropdown-item py-2" asp-area="App" asp-controller="Expenses" asp-action="Edit" asp-route-id="@item.ExpenseId" asp-route-siteId="@item.SiteId">
                        <strong>@item.ExpenseTypeName</strong>: @item.Description<br />
                        <small class="text-muted">@item.Amount.ToString("N2") ₺ - Vade: @item.DueDate.ToString("dd.MM.yyyy")</small>
                    </a>
                </li>
            }
            @if (overdueExpenses.Count > 5)
            {
                var firstExp = overdueExpenses.First();
                <li>
                    <a class="dropdown-item text-primary py-1" asp-area="App" asp-controller="Expenses" asp-action="Index" asp-route-siteId="@firstExp.SiteId">Tümünü gör (@overdueExpenses.Count gider)</a>
                </li>
            }
        }
        else
        {
            <li><span class="dropdown-item text-muted py-1">Süresi geçen gider yok.</span></li>
        }

        <li><hr class="dropdown-divider" /></li>
        <li><h6 class="dropdown-header">Borçlular</h6></li>
        @if (debtors.Count > 0)
        {
            @foreach (var d in debtors.Take(5))
            {
                <li>
                    <a class="dropdown-item py-2" asp-area="App" asp-controller="Debtors" asp-action="Index" asp-route-siteId="@d.SiteId">
                        <strong>@d.BlockOrBuildingName @d.ApartmentNumber</strong> - @(d.OwnerName ?? "-")<br />
                        <small class="text-muted">@(d.OwnerPhone ?? "-") · @(d.OldestDebtDate?.ToString("dd.MM.yyyy") ?? "-") · @(d.DaysOverdue.HasValue ? $"{d.DaysOverdue} gün gecikmiş" : "-") · @d.UnpaidIncome.ToString("N2") ₺</small>
                    </a>
                </li>
            }
            @if (debtors.Count > 5)
            {
                var firstDebtor = debtors.First();
                <li>
                    <a class="dropdown-item text-primary py-1" asp-area="App" asp-controller="Debtors" asp-action="Index" asp-route-siteId="@firstDebtor.SiteId">Tümünü gör (@debtors.Count borçlu)</a>
                </li>
            }
        }
        else
        {
            <li><span class="dropdown-item text-muted py-1">Borcu bulunan daire yok.</span></li>
        }
        }
    </ul>
</div>

@model SiteYonetim.Domain.Interfaces.YearlyReportDetailDto
@{
    var siteId = (Guid)ViewBag.SiteId;
    var siteName = ViewBag.SiteName as string ?? "";
    var year = (int)ViewBag.Year;
    var monthNames = new[] { "", "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık" };
    ViewData["Title"] = $"{year} - {siteName}";
}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 no-print">
    <h1 class="h3 mb-0">@year - @siteName</h1>
    <div class="d-flex gap-2 align-items-center">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showDetails" checked onchange="toggleDetails(this.checked)">
            <label class="form-check-label" for="showDetails">Detayları göster (kalem kalem)</label>
        </div>
        <a asp-area="App" asp-controller="Reports" asp-action="YearlyExcel" asp-route-siteId="@siteId" asp-route-year="@year" class="btn btn-success">
            <i class="bi bi-file-earmark-excel me-1"></i> Excel İndir
        </a>
        <button type="button" class="btn btn-primary" onclick="window.print();">
            <i class="bi bi-printer me-1"></i> Yazdır
        </button>
        <a asp-area="App" asp-controller="Reports" asp-action="Index" asp-route-siteId="@siteId" class="btn btn-outline-secondary">Geri</a>
    </div>
</div>

<div class="print-only mb-3" style="display:none;">
    <h2 class="h4">@year - @siteName</h2>
</div>
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light"><strong>Yıllık Finans Özeti (@year)</strong></div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6 col-lg-3">
                <p class="mb-0 text-muted small">Önceki Yıllar Devir Bakiyesi (Açılış)</p>
                <p class="mb-0 small text-muted">(Yıl başındaki kasa)</p>
                <h5 class="mb-0">@Model.OpeningBalance.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-6 col-lg-3">
                <p class="mb-0 text-muted small">Tahsil Edilen (@year)</p>
                <p class="mb-0 small text-muted">(O yıl içinde tahsil edilen tüm gelirler)</p>
                <h5 class="mb-0 text-success">@Model.TotalIncome.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-6 col-lg-3">
                <p class="mb-0 text-muted small">Bekleyen Aidat ve Diğer Gelirler</p>
                <p class="mb-0 small text-muted">(Bu yıl için - sadece bilgi)</p>
                <h5 class="mb-0 text-secondary">@Model.PendingIncome.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-6 col-lg-3">
                <p class="mb-0 text-muted small">Yıllık Toplam Gider</p>
                <p class="mb-0 small text-muted">(O yıl içinde girilen tüm giderler)</p>
                <h5 class="mb-0 text-danger">@Model.TotalExpense.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-6 col-lg-3">
                <p class="mb-0 text-muted small">Yıllık Bakiye</p>
                <p class="mb-0 small text-muted">Devir + Tahsil - Gider</p>
                <h5 class="mb-0 @(Model.Balance >= 0 ? "text-primary" : "text-warning")">@Model.Balance.ToString("N2") ₺</h5>
            </div>
        </div>
    </div>
</div>
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent"><strong>Aylık Özet (Tutarlılık kontrolü için)</strong></div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Ay</th>
                    <th>Devir</th>
                    <th>Gelir (Tahsil)</th>
                    <th>Gider</th>
                    <th>Bakiye</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model.ByMonth)
                {
                    <tr>
                        <td>@monthNames[m.Month]</td>
                        <td>@m.OpeningBalance.ToString("N2") ₺</td>
                        <td>@m.TotalIncome.ToString("N2") ₺</td>
                        <td>@m.TotalExpense.ToString("N2") ₺</td>
                        <td>@m.Balance.ToString("N2") ₺</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div id="yearlyDetailSections" class="yearly-detail-sections">
    @foreach (var monthDetail in Model.ByMonthDetail)
    {
        var monthName = monthNames[monthDetail.Month];
        <div class="yearly-detail-section mb-4">
            <h5 class="mb-3 text-primary">@monthName @year - Detay</h5>
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-success text-white py-2">
                            <h6 class="mb-0"><i class="bi bi-arrow-down-circle me-2"></i>Gelirler (Kalem Kalem)</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Blok/Bina</th>
                                            <th>Daire No</th>
                                            <th>Ev Sahibi / Kiracı</th>
                                            <th>Tür</th>
                                            <th>Açıklama</th>
                                            <th class="text-end">Tutar</th>
                                            <th class="text-end">Tahsil</th>
                                            <th class="text-end">Kalan</th>
                                            <th>Vade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in monthDetail.IncomeItems)
                                        {
                                            <tr>
                                                <td>@item.BlockOrBuildingName</td>
                                                <td>@item.ApartmentNumber</td>
                                                <td>@(item.OwnerName ?? "-")</td>
                                                <td>@item.TypeName</td>
                                                <td>@(item.Description ?? "-")</td>
                                                <td class="text-end">@item.Amount.ToString("N2") ₺</td>
                                                <td class="text-end">@item.PaidAmount.ToString("N2") ₺</td>
                                                <td class="text-end @(item.RemainingAmount > 0 ? "text-warning fw-bold" : "")">@item.RemainingAmount.ToString("N2") ₺</td>
                                                <td>@item.DueDate.ToString("dd.MM.yyyy")</td>
                                            </tr>
                                        }
                                        @if (!monthDetail.IncomeItems.Any())
                                        {
                                            <tr><td colspan="9" class="text-center text-muted py-2">Bu ayda gelir kaydı yok.</td></tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-light fw-bold">
                                        <tr>
                                            <td colspan="5" class="text-end">Toplam Tahsil:</td>
                                            <td class="text-end" colspan="2">@monthDetail.TotalIncome.ToString("N2") ₺</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-danger text-white py-2">
                            <h6 class="mb-0"><i class="bi bi-arrow-up-circle me-2"></i>Giderler (Kalem Kalem)</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Gider Türü</th>
                                            <th>Açıklama</th>
                                            <th>Tarih</th>
                                            <th>Fatura No</th>
                                            <th class="text-end">Tutar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in monthDetail.ExpenseItems)
                                        {
                                            <tr>
                                                <td>@item.ExpenseTypeName</td>
                                                <td>@item.Description</td>
                                                <td>@item.ExpenseDate.ToString("dd.MM.yyyy")</td>
                                                <td>@(item.InvoiceNumber ?? "-")</td>
                                                <td class="text-end">@item.Amount.ToString("N2") ₺</td>
                                            </tr>
                                        }
                                        @if (!monthDetail.ExpenseItems.Any())
                                        {
                                            <tr><td colspan="5" class="text-center text-muted py-2">Bu ayda gider kaydı yok.</td></tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-light fw-bold">
                                        <tr>
                                            <td colspan="4" class="text-end">Toplam Gider:</td>
                                            <td class="text-end">@monthDetail.TotalExpense.ToString("N2") ₺</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script>
    function toggleDetails(show) {
        var sections = document.getElementById('yearlyDetailSections');
        if (show) {
            sections.classList.remove('hide-details');
        } else {
            sections.classList.add('hide-details');
        }
    }
</script>

<style>
    .yearly-detail-sections.hide-details { display: none !important; }
    @@media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        .report-summary-row { display: flex !important; flex-wrap: nowrap !important; }
        .report-summary-row > div { flex: 0 0 25% !important; max-width: 25% !important; }
        .yearly-detail-sections { display: block !important; }
        .yearly-detail-sections.hide-details { display: block !important; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .card-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
</style>

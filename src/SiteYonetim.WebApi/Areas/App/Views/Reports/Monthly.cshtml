@model SiteYonetim.Domain.Interfaces.MonthlyReportDetailDto
@{
    var siteId = (Guid)ViewBag.SiteId;
    var siteName = ViewBag.SiteName as string ?? "";
    var year = (int)ViewBag.Year;
    var month = (int)ViewBag.Month;
    var monthName = ViewBag.MonthName as string ?? "";
    ViewData["Title"] = $"{year} {monthName} - {siteName}";
}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 no-print">
    <h1 class="h3 mb-0">@year @monthName - @siteName</h1>
    <div class="d-flex gap-2">
        <a asp-area="App" asp-controller="Reports" asp-action="MonthlyExcel" asp-route-siteId="@siteId" asp-route-year="@year" asp-route-month="@month" class="btn btn-success">
            <i class="bi bi-file-earmark-excel me-1"></i> Excel İndir
        </a>
        <button type="button" class="btn btn-primary" onclick="window.print();">
            <i class="bi bi-printer me-1"></i> Yazdır
        </button>
        <a asp-area="App" asp-controller="Reports" asp-action="Index" asp-route-siteId="@siteId" class="btn btn-outline-secondary">Geri</a>
    </div>
</div>

<div class="print-only mb-3" style="display:none;">
    <h2 class="h4">@year @monthName - @siteName</h2>
</div>
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light"><strong>Aylık Finans Özeti</strong></div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4 col-lg-2">
                <p class="mb-0 text-muted small">Devir Bakiyesi</p>
                <p class="mb-0 small text-muted">(Bir önceki ayın kapanış bakiyesi)</p>
                <h5 class="mb-0">@Model.OpeningBalance.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-4 col-lg-2">
                <p class="mb-0 text-muted small">Tahsil Edilen</p>
                <p class="mb-0 small text-muted">(Bu ay yapılan tüm tahsilatlar)</p>
                <h5 class="mb-0 text-success">@Model.TotalIncome.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-4 col-lg-2">
                <p class="mb-0 text-muted small">Bekleyen Aidat ve Diğer Gelirler</p>
                <p class="mb-0 small text-muted">(Bu ay için - sadece bilgi)</p>
                <h5 class="mb-0 text-secondary">@Model.PendingIncome.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-4 col-lg-2">
                <p class="mb-0 text-muted small">Ek Gelir (Bu ay)</p>
                <p class="mb-0 small text-muted">(Özel toplama + diğer)</p>
                <h5 class="mb-0 text-info">@Model.ExtraCollectionIncome.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-4 col-lg-2">
                <p class="mb-0 text-muted small">Toplam Gider</p>
                <p class="mb-0 small text-muted">(Sadece bu ayın giderleri)</p>
                <h5 class="mb-0 text-danger">@Model.TotalExpense.ToString("N2") ₺</h5>
            </div>
            <div class="col-md-4 col-lg-2">
                <p class="mb-0 text-muted small">Bakiye</p>
                <p class="mb-0 small text-muted">Devir + Tahsil - Gider</p>
                <h5 class="mb-0 @(Model.Balance >= 0 ? "text-primary" : "text-warning")">@Model.Balance.ToString("N2") ₺</h5>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-arrow-down-circle me-2"></i>Gelirler (Kalem Kalem)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Blok/Bina</th>
                                <th>Daire No</th>
                                <th>Ev Sahibi</th>
                                <th>Tür</th>
                                <th>Açıklama</th>
                                <th class="text-end">Tutar</th>
                                <th class="text-end">Tahsil Edilen</th>
                                <th class="text-end">Kalan</th>
                                <th>Vade</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.IncomeItems)
                            {
                                <tr>
                                    <td>@item.BlockOrBuildingName</td>
                                    <td>@item.ApartmentNumber</td>
                                    <td>@(item.OwnerName ?? "-")</td>
                                    <td>@item.TypeName</td>
                                    <td>@(item.Description ?? "-")</td>
                                    <td class="text-end">@item.Amount.ToString("N2") ₺</td>
                                    <td class="text-end">@item.PaidAmount.ToString("N2") ₺</td>
                                    <td class="text-end @(item.RemainingAmount > 0 ? "text-warning fw-bold" : "")">@item.RemainingAmount.ToString("N2") ₺</td>
                                    <td>@item.DueDate.ToString("dd.MM.yyyy")</td>
                                </tr>
                            }
                            @if (!Model.IncomeItems.Any())
                            {
                                <tr><td colspan="9" class="text-center text-muted py-3">Bu ayda gelir kaydı bulunmuyor.</td></tr>
                            }
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td colspan="5" class="text-end">Toplam Tahsil (Gelir):</td>
                                <td class="text-end" colspan="2">@Model.TotalIncome.ToString("N2") ₺</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-arrow-up-circle me-2"></i>Giderler (Kalem Kalem)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Gider Türü</th>
                                <th>Açıklama</th>
                                <th>Tarih</th>
                                <th>Fatura No</th>
                                <th class="text-end">Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ExpenseItems)
                            {
                                <tr>
                                    <td>@item.ExpenseTypeName</td>
                                    <td>@item.Description</td>
                                    <td>@item.ExpenseDate.ToString("dd.MM.yyyy")</td>
                                    <td>@(item.InvoiceNumber ?? "-")</td>
                                    <td class="text-end">@item.Amount.ToString("N2") ₺</td>
                                </tr>
                            }
                            @if (!Model.ExpenseItems.Any())
                            {
                                <tr><td colspan="5" class="text-center text-muted py-3">Bu ayda gider kaydı bulunmuyor.</td></tr>
                            }
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td colspan="4" class="text-end">Toplam Gider:</td>
                                <td class="text-end">@Model.TotalExpense.ToString("N2") ₺</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm border-primary">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="mb-0">Bakiye (Ay sonu kasa)</h5>
                <p class="text-muted small mb-0">Formül: Devir Bakiyesi + Tahsil Edilen – Toplam Gider</p>
            </div>
            <div class="col-md-4 text-end">
                <h3 class="mb-0 @(Model.Balance >= 0 ? "text-success" : "text-danger")">@Model.Balance.ToString("N2") ₺</h3>
            </div>
        </div>
    </div>
</div>

<style>
    @@media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .card-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
</style>
